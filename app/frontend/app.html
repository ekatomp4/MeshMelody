<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>App</title>
    <link rel="stylesheet" href="/all/all.css">
</head>

<body>

    <nav>
        <button onclick="loadPage(['home'])">Home</button>
        <button onclick="loadPage(['auth'])">Login</button>
        <button onclick="loadPage(['auth'])">Register</button>
    </nav>

    <div id="app-root"></div>

    <script>


        // Handle back/forward buttons globally
        window.onpopstate = function (event) {
            const pathHeirarchy = window.location.pathname.slice(1).split('/');
        };

        // Change the URL and load a page
        function editPath(path) {
            const newUrl = '/' + path;
            window.history.pushState({ path: newUrl }, '', newUrl);
            const pathHeirarchy = path.split('/');
        }

        window.editPath = editPath;



        const req = JSON.parse(`[[DATA]]`);
        // frontend loader here
        const appRoot = document.getElementById('app-root');
        // have cache

        const pageCache = {};

        // TODO HAVE CACHING
        async function loadPage(pathHeirarchy) {
            if (pathHeirarchy.length === 0 || (pathHeirarchy.length === 1 && pathHeirarchy[0] === '')) {
                pathHeirarchy = ['home'];
            }

            const elements = appRoot.children;
            for (let i = 0; i < elements.length; i++) elements[i].classList.remove('active');

            if (pageCache[pathHeirarchy[0]]) {
                const element = pageCache[pathHeirarchy[0]];
                element.classList.add('active');
                appRoot.appendChild(element);
                editPath(pathHeirarchy.join('/'));
                return;
            }

            let pageContent = null;
            try {
                const response = await fetch(`/page/${pathHeirarchy[0]}`);
                if (!response.ok) throw new Error(`HTTP ${response.status}`);
                pageContent = await response.text();
            } catch (e) {
                pageContent = `<main class="active"><h1>404 NOT FOUND</h1></main>`;
            }

            const tempDiv = document.createElement('div');
            tempDiv.innerHTML = pageContent.trim(); // use a container
            const element = tempDiv.firstElementChild; // ensures you get an element, not text node
            if (!element) return console.error("Failed to parse page", pathHeirarchy[0]);

            // Move scripts out and execute them properly
            const scripts = element.querySelectorAll('script');
            scripts.forEach(oldScript => {
                const newScript = document.createElement('script');
                Array.from(oldScript.attributes).forEach(attr =>
                    newScript.setAttribute(attr.name, attr.value)
                );
                newScript.text = oldScript.text;
                document.body.appendChild(newScript); // append to live DOM to execute
                oldScript.remove(); // remove original
            });

            element.classList.add('active');
            appRoot.appendChild(element);

            pageCache[pathHeirarchy[0]] = element;

            editPath(pathHeirarchy.join('/'));
        }


        loadPage(req.pathHeirarchy);


    </script>

    <script src="/all/all.js" type="module"></script>
</body>

</html>