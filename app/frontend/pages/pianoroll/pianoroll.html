<main class="pianoroll">
    <link rel="stylesheet" href="/pages/pianoroll/pianoroll.css">
    <div id="container">
        <div id="piano-keys"></div>
        <div id="roll-area">
            <div id="grid"></div>
        </div>
    </div>
    
    
    
    <script>
        // Note names starting from E0 to E6 (52 notes total from E0-E6)
        // But we need 127 notes ending on E, so we'll go from E-2 to E8
        function setupPianoRoll() {
        const notes = [];
        const noteNames = ['C', 'C#', 'D', 'D#', 'E', 'F', 'F#', 'G', 'G#', 'A', 'A#', 'B'];
        
        // Generate 127 notes starting from E
        // Start from E-2 (MIDI note 16) to E8 (MIDI note 142, but we cap at 127)

        for (let i = 127; i >= 1; i--) {
            const noteIndex = (i + 8) % 12; // Offset to start on E
            const octave = Math.floor((i + 8) / 12) - 2;
            const noteName = noteNames[noteIndex] + octave;
            const isBlack = noteNames[noteIndex].includes('#');
            notes.push({ name: noteName, isBlack: isBlack });
        }
        
        // Create piano keys
        const pianoKeys = document.getElementById('piano-keys');
        notes.forEach(note => {
            const key = document.createElement('div');
            key.className = `key ${note.isBlack ? 'black' : 'white'}`;
            key.textContent = note.name;
            pianoKeys.appendChild(key);
        });
        
        // Create grid
        const grid = document.getElementById('grid');
        const rollWidth = 4000; // Width of the roll area
        const rollHeight = notes.length * 20;
        
        grid.style.width = rollWidth + 'px';
        grid.style.height = rollHeight + 'px';
        
        // Create horizontal grid lines
        notes.forEach((note, index) => {
            const line = document.createElement('div');
            line.className = `grid-line ${note.isBlack ? 'black-note' : 'white-note'}`;
            line.style.top = (index * 20) + 'px';
            grid.appendChild(line);
        });
        
        // Create vertical beat lines (16th notes)
        const beatWidth = 30; // Width of each 16th note
        for (let i = 0; i < rollWidth / beatWidth; i++) {
            const line = document.createElement('div');
            line.className = i % 16 === 0 ? 'bar-line' : 'beat-line';
            line.style.left = (i * beatWidth) + 'px';
            grid.appendChild(line);
        }
        
        // Sync scroll between piano keys and roll area
        const rollArea = document.getElementById('roll-area');
        rollArea.addEventListener('scroll', () => {
            pianoKeys.scrollTop = rollArea.scrollTop;
        });
        extendedKeyPlace();
    };
    // note placing
    function extendedKeyPlace() {
        const pianoKeys = document.getElementById('piano-keys');
        const rollArea = document.getElementById('roll-area');
        var isDragging = false;
// these are waiting to be used (X)
        // ---
        let xl = 30;
        let yl = 20;
        // these are waiting to be used (Y)
        rollArea.addEventListener('click', (e) => {
            console.log('clicked at x:', e.clientX, 'y:', e.clientY);
        });
        rollArea.addEventListener('mousedown', (e) => {
            const rect = rollArea.getBoundingClientRect();
            xl = e.clientX - rect.left;
            yl = e.clientY - rect.top; 

            // add feature where it defines note class based on instrument, etc.
                currentNote = document.createElement('div');
                currentNote.style.position = 'absolute';
                currentNote.style.left = xl + 'px';
                currentNote.style.top = (yl) + 'px';
                currentNote.style.width = '1px';
                currentNote.style.height = '20px';
                currentNote.style.background = '#4a9eff';
                currentNote.style.border = '1px solid #2070d0';
                grid.appendChild(currentNote);
                const left = parseFloat(currentNote.style.left);
                const top = parseFloat(currentNote.style.top);
                const width = parseFloat(currentNote.style.width);
                const snappedTop = Math.floor(top / 20) * 20;
                currentNote.style.top = snappedTop + 'px';
                isDragging = true;
                console.log(`rect.left: ${rect.left}, rect.top: ${rect.top}, scrollLeft: ${rollArea.scrollLeft}, scrollTop: ${rollArea.scrollTop}`);
                const noteIndex = Math.floor(yl / 20); // 20px per row
                const noteName = pianoKeys.children[noteIndex].textContent;
                currentNote.dataset.note = noteName; // look over
                console.log(`Starts at X: ${xl}, Y: ${yl} - Note: ${noteName}`);
                
        });
        rollArea.addEventListener('mousemove', (e) => {
                // xl = e.clientX - rect.left;
                // yl = e.clientY - rect.top; 
            if (isDragging) {
                console.log('Dragging to x:', xl, 'y:', yl);
                const rect = rollArea.getBoundingClientRect();
                const x = e.clientX - rect.left + rollArea.scrollLeft;
                const width = (x - xl);
                if (width < 1) return; // Prevent negative width
                currentNote.style.width = width + 'px';
                // Optionally, you can visualize the drag selection here
            }
        });
        rollArea.addEventListener('mouseup', (e) => {
            if (isDragging) {
                isDragging = false;
                
                // Now snap to grid

                
                // const snappedLeft = Math.floor(left / 30) * 30;
                
                // const snappedWidth = Math.ceil(width / 30) * 30;
                
                // currentNote.style.left = snappedLeft + 'px';
                
                // currentNote.style.width = snappedWidth + 'px';
                
                // console.log(`Note snapped to: X=${snappedLeft}, Y=${snappedTop}, Width=${snappedWidth}`);
                
                
            }
            
        });
    }
    window.addEventListener("page-loaded", setupPianoRoll);

    </script>
</main>